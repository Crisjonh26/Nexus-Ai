<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="https://i.imgur.com/doC2PNN.jpeg">
    <title>Nexus AI</title>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #8e2de2, #4a00e0);
            --background-dark: #0f0f1a;
            --background-darker: #0a0a12;
            --user-bubble: #4a6bff;
            --ai-bubble: #2a2a3a;
            --text-light: #f0f0f5;
            --text-lighter: #ffffff;
            --code-bg: #1a1a2a;
            --accent-color: #6c5ce7;
            --menu-bg: #2a2a3a;
            --highlight-color: rgba(108, 92, 231, 0.2);
            --timestamp-color: rgba(255, 255, 255, 0.4);
            --favorite-color: #ffca28;
            --dislike-color: #ff6b6b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background-dark);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            overflow: hidden;
            touch-action: manipulation;
            position: relative;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            background: var(--primary-gradient);
            border-radius: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 36px;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-light);
            font-size: 1.2rem;
            margin-top: 20px;
        }

        /* Introduction Screen */
        .intro-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            text-align: center;
            transition: opacity 0.5s ease, transform 0.5s ease;
            overflow-y: auto;
        }

        .intro-screen.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-20px);
        }

        .intro-content {
            max-width: 1200px;
            width: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .intro-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            background-color: white;
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #4a00e0;
            font-size: 36px;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: blink 2s infinite;
            line-height: 1;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }

        .intro-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: white;
        }

        .intro-subtitle {
            font-size: 1rem;
            margin-bottom: 25px;
            color: rgba(255, 255, 255, 0.9);
            max-width: 700px;
            line-height: 1.6;
        }

        .intro-features {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            max-width: 1000px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px 15px;
            width: 100%;
            max-width: 300px;
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .feature-icon {
            font-size: 1.8rem;
            margin-bottom: 12px;
            color: white;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .feature-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: white;
            font-size: 1.1rem;
        }

        .feature-desc {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
        }

        .get-started-btn {
            background: white;
            color: #4a00e0;
            border: none;
            padding: 14px 30px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            margin-top: 15px;
            width: 100%;
            max-width: 300px;
        }

        .get-started-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .get-started-btn:active {
            transform: translateY(0);
        }

        .copyright {
            margin-top: 30px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Header Styles */
        .header {
            background: var(--primary-gradient);
            color: white;
            padding: 16px 0;
            text-align: center;
            width: 100%;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            z-index: 10;
        }

        .header h1 {
            font-weight: 600;
            font-size: 1.3rem;
            letter-spacing: -0.5px;
            display: inline-block;
            margin: 0;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 6px;
        }

        .typing-dot {
            height: 8px;
            width: 8px;
            background-color: white;
            border-radius: 50%;
            display: inline-block;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% { 
                transform: translateY(0);
                opacity: 0.6;
            }
            30% { 
                transform: translateY(-5px);
                opacity: 1;
                background-color: #ffffff;
            }
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
            width: 100%;
            display: flex;
            flex-direction: column;
            display: none;
            position: relative;
            z-index: 2;
        }

        .message-container {
            display: flex;
            margin-bottom: 20px;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            animation: fadeIn 0.25s ease-out;
            position: relative;
            z-index: 2;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.9); }
        }

        .user-message-container {
            justify-content: flex-end;
        }

        .ai-message-container {
            justify-content: flex-start;
        }

        .profile-pic {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin: 0 12px;
            object-fit: cover;
            flex-shrink: 0;
            align-self: flex-end;
            order: 1;
        }

        .user-message-container .profile-pic {
            order: 1;
        }

        .ai-message-container .profile-pic {
            order: 0;
        }

        .message-content {
            display: flex;
            flex-direction: column;
            max-width: calc(100% - 60px);
        }

        .message {
            padding: 14px 18px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 0.95rem;
            max-width: 100%;
            word-wrap: break-word;
            user-select: text;
            -webkit-user-select: text;
        }

        .user-message {
            background: var(--primary-gradient);
            color: var(--text-lighter);
            border-bottom-right-radius: 4px;
            order: 0;
        }

        .ai-message {
            background-color: var(--ai-bubble);
            border-bottom-left-radius: 4px;
        }

        /* Timestamp styling */
        .message-timestamp {
            font-size: 0.7rem;
            color: var(--timestamp-color);
            margin-top: 4px;
            align-self: flex-end;
            font-family: 'Inter', sans-serif;
        }

        /* Enhanced message formatting */
        .ai-message .question-highlight {
            background-color: var(--highlight-color);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
            margin: 5px 0;
            display: inline-block;
        }

        .ai-message ol, 
        .ai-message ul {
            padding-left: 20px;
            margin: 8px 0;
        }

        .ai-message li {
            margin-bottom: 6px;
        }

        .ai-message p {
            margin-bottom: 10px;
        }

        .ai-message .step {
            margin-bottom: 12px;
        }

        .ai-message .step-number {
            font-weight: bold;
            color: var(--accent-color);
            margin-right: 5px;
        }

        /* Image message styling */
        .image-message {
            max-width: 100%;
            border-radius: 12px;
            margin-top: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .image-message:hover {
            transform: scale(1.02);
        }

        .image-preview-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
        }

        .remove-image-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        .input-area {
            padding: 16px;
            background-color: var(--background-darker);
            display: flex;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            z-index: 10;
            display: none;
        }

        #user-input {
            flex: 1;
            padding: 12px 90px 12px 18px;
            border: none;
            border-radius: 24px;
            font-size: 0.95rem;
            background-color: rgba(255, 255, 255, 0.08);
            color: var(--text-light);
            outline: none;
            transition: background-color 0.2s;
        }

        #user-input:focus {
            background-color: rgba(255, 255, 255, 0.12);
        }

        #user-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        #send-button {
            position: absolute;
            right: 28px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 1.2rem;
            transition: transform 0.1s, opacity 0.2s;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        #send-button:hover {
            background: rgba(108, 92, 231, 0.1);
        }

        #send-button:active {
            transform: translateY(-50%) scale(0.95);
        }

        #image-upload-button {
            position: absolute;
            right: 70px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 1.2rem;
            transition: transform 0.1s, opacity 0.2s;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        #image-upload-button:hover {
            background: rgba(108, 92, 231, 0.1);
        }

        #image-upload-button:active {
            transform: translateY(-50%) scale(0.95);
        }

        /* Image Upload Options */
        .image-upload-options {
            position: fixed;
            bottom: 80px;
            right: 80px;
            background: var(--menu-bg);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 100;
            display: none;
            flex-direction: column;
            overflow: hidden;
            min-width: 180px;
            backdrop-filter: blur(10px);
        }

        .image-upload-options button {
            background: none;
            border: none;
            color: var(--text-light);
            padding: 12px 16px;
            text-align: left;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s;
        }

        .image-upload-options button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .image-upload-options button i {
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }

        /* Code Block Styling */
        .code-block {
            position: relative;
            margin: 12px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            background-color: var(--code-bg);
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #252537;
            padding: 8px 12px;
            font-family: 'Fira Code', monospace;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .code-language {
            font-weight: 500;
        }

        .code-actions {
            display: flex;
            gap: 8px;
        }

        .code-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .copy-btn {
            background-color: rgba(33, 150, 243, 0.1);
            color: #2196F3;
        }

        .run-btn {
            background-color: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
        }

        .code-btn:hover {
            color: white;
        }

        .copy-btn:hover {
            background-color: rgba(33, 150, 243, 0.2);
        }

        .run-btn:hover {
            background-color: rgba(76, 175, 80, 0.2);
        }

        .code-btn i {
            font-size: 0.9rem;
        }

        pre {
            padding: 16px;
            margin: 0;
            overflow-x: auto;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            background-color: var(--code-bg);
        }

        code {
            font-family: inherit;
            color: #e0e0e0;
            background-color: transparent;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background-color: var(--menu-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 100;
            display: none;
            flex-direction: column;
            overflow: hidden;
            min-width: 180px;
            backdrop-filter: blur(10px);
        }

        .voice-options {
            display: none;
            flex-direction: column;
            padding: 8px 0;
            background-color: rgba(0,0,0,0.1);
        }

        .voice-options button {
            padding: 8px 16px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .voice-options button:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .context-menu button {
            background: none;
            border: none;
            color: var(--text-light);
            padding: 10px 16px;
            text-align: left;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .context-menu button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .context-menu button i {
            font-size: 1rem;
        }

        .context-menu .divider {
            height: 1px;
            background-color: rgba(255, 255, 255, 0.1);
            margin: 4px 0;
        }

        /* Edit Input */
        .edit-message-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: var(--ai-bubble);
            color: var(--text-light);
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            line-height: 1.5;
            resize: none;
            outline: none;
            margin-bottom: 8px;
        }

        .edit-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
        }

        .edit-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            border: none;
        }

        .save-edit-btn {
            background-color: var(--accent-color);
            color: white;
        }

        .cancel-edit-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
        }

        /* Reply indicator */
        .reply-indicator {
            background-color: rgba(255, 255, 255, 0.05);
            border-left: 3px solid var(--accent-color);
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: var(--text-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reply-username {
            font-weight: 500;
            color: var(--accent-color);
        }

        .reply-content {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            margin: 0 8px;
        }

        .cancel-reply-btn {
            background: none;
            border: none;
            color: var(--timestamp-color);
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* Clear Chat Button */
        .clear-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 10;
            display: none;
        }

        /* Code Execution Modal */
        .code-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .code-modal-content {
            background-color: var(--background-darker);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }

        .code-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #252537;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .code-modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .close-modal:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .code-output-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .code-output {
            width: 100%;
            max-width: 100%;
            font-family: 'Fira Code', monospace;
            white-space: pre-wrap;
            color: #333;
            font-size: 0.95rem;
            line-height: 1.6;
            text-align: left;
        }

        .code-output iframe {
            width: 100%;
            height: 400px;
            border: none;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .execution-success {
            color: #4CAF50;
            font-weight: 500;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .execution-error {
            color: #F44336;
            font-weight: 500;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Image Modal */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
        }

        .image-modal-content img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 8px;
        }

        .close-image-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }

        /* Reaction buttons */
        .reaction-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            align-self: flex-end;
        }

        .reaction-btn {
            background: none;
            border: none;
            color: var(--timestamp-color);
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .reaction-btn:hover {
            color: var(--text-light);
        }

        .like-btn.liked {
            color: var(--favorite-color);
        }

        .dislike-btn.disliked {
            color: var(--dislike-color);
        }

        /* Favorites view */
        .favorites-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-dark);
            z-index: 1000;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .favorites-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .favorites-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close-favorites {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .favorites-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .favorite-item {
            background-color: var(--ai-bubble);
            border-radius: 12px;
            padding: 15px;
            position: relative;
        }

        .favorite-content {
            margin-bottom: 10px;
        }

        .favorite-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--timestamp-color);
        }

        .remove-favorite {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--dislike-color);
            cursor: pointer;
        }

        /* Export options */
        .export-options {
            display: none;
            flex-direction: column;
            padding: 8px 0;
            background-color: rgba(0,0,0,0.1);
        }

        .export-options button {
            padding: 8px 16px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-options button:hover {
            background-color: rgba(255,255,255,0.1);
        }

        /* Favorites Button */
        .favorites-btn {
            position: fixed;
            bottom: 80px;
            right: 80px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 10;
            display: none;
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .intro-logo {
                width: 120px;
                height: 120px;
                font-size: 48px;
                margin-bottom: 30px;
                border-radius: 24px;
            }
            
            .intro-title {
                font-size: 2.2rem;
            }
            
            .intro-subtitle {
                font-size: 1.1rem;
                margin-bottom: 30px;
            }
            
            .feature-card {
                width: calc(50% - 15px);
                padding: 25px 20px;
            }
            
            .feature-icon {
                font-size: 2rem;
                width: 60px;
                height: 60px;
            }
            
            .feature-title {
                font-size: 1.2rem;
            }
            
            .feature-desc {
                font-size: 0.9rem;
            }
            
            .get-started-btn {
                padding: 16px 40px;
                font-size: 1.1rem;
                width: auto;
            }

            .header h1 {
                font-size: 1.5rem;
            }
        }

        @media (min-width: 1024px) {
            .intro-content {
                padding: 40px;
            }
            
            .intro-title {
                font-size: 2.5rem;
            }
            
            .intro-subtitle {
                font-size: 1.2rem;
                margin-bottom: 40px;
            }
            
            .feature-card {
                width: calc(33.333% - 20px);
                padding: 30px 25px;
            }
            
            .feature-icon {
                font-size: 2.2rem;
                width: 70px;
                height: 70px;
            }
            
            .feature-title {
                font-size: 1.2rem;
            }
            
            .feature-desc {
                font-size: 1rem;
            }
            
            .get-started-btn {
                padding: 18px 50px;
                font-size: 1.2rem;
            }
        }

        @media (max-width: 768px) {
            .message {
                padding: 12px 16px;
                font-size: 0.9rem;
            }
            .profile-pic {
                width: 32px;
                height: 32px;
                margin: 0 8px;
            }
            .input-area {
                padding: 12px;
            }
            #user-input {
                padding: 10px 80px 10px 16px;
            }
            #send-button {
                right: 22px;
            }
            #image-upload-button {
                right: 60px;
            }
            .clear-btn {
                bottom: 70px;
                right: 15px;
                width: 40px;
                height: 40px;
            }
            .code-modal-content {
                width: 95%;
            }
            .code-output iframe {
                height: 300px;
            }
            .image-upload-options {
                right: 60px;
                bottom: 70px;
            }
            .favorites-btn {
                right: 60px;
                bottom: 70px;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- PDF export library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-logo">N</div>
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Nexus AI...</div>
    </div>

    <!-- Introduction Screen -->
    <div class="intro-screen" id="intro-screen">
        <div class="intro-content">
            <div class="intro-logo">N</div>
            <h1 class="intro-title">Welcome to Nexus AI</h1>
            <p class="intro-subtitle">Your intelligent assistant for coding, learning, and productivity. Get instant answers, code execution, and smart assistance with our advanced AI technology.</p>
            
            <div class="intro-features">
                <div class="feature-card">
                    <div class="feature-icon"><i class="fas fa-code"></i></div>
                    <h3 class="feature-title">Code Execution</h3>
                    <p class="feature-desc">Run and test code snippets directly in the chat with our built-in code executor</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon"><i class="fas fa-image"></i></div>
                    <h3 class="feature-title">Image Analysis</h3>
                    <p class="feature-desc">Upload images and get detailed descriptions or answers about their content</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon"><i class="fas fa-robot"></i></div>
                    <h3 class="feature-title">Multi-Purpose</h3>
                    <p class="feature-desc">Get help with coding, learning, content creation, and problem solving</p>
                </div>
            </div>
            
            <button class="get-started-btn" id="get-started-btn">
                Get Started
            </button>
            
            <div class="copyright">
                © 2025 Nexus AI. All rights reserved.
            </div>
        </div>
    </div>

    <div class="header" id="header" style="display: none;">
        <h1>Nexus AI</h1>
        <div class="typing-indicator" id="typing-indicator">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
        </div>
    </div>
    
    <div class="chat-container" id="chat-container" style="display: none;"></div>
    
    <div class="input-area" id="input-area" style="display: none;">
        <input type="text" id="user-input" placeholder="Message Nexus..." autocomplete="off">
        <button id="image-upload-button" title="Upload Image">
            <i class="fas fa-image"></i>
        </button>
        <button id="send-button"><i class="fas fa-paper-plane"></i></button>
    </div>

    <!-- Image Upload Options -->
    <div class="image-upload-options" id="image-upload-options">
        <button id="upload-from-gallery">
            <i class="fas fa-images"></i> Choose from Gallery
        </button>
        <button id="capture-photo">
            <i class="fas fa-camera"></i> Take Photo
        </button>
    </div>

    <!-- Context Menu Template -->
    <div class="context-menu" id="context-menu">
        <button id="copy-btn"><i class="fas fa-copy"></i> Copy</button>
        <button id="select-text-btn"><i class="fas fa-highlighter"></i> Select Text</button>
        <button id="speak-btn"><i class="fas fa-volume-up"></i> Speak</button>
        <div class="voice-options" id="voice-options">
            <button data-voice="male"><i class="fas fa-male"></i> Male Voice</button>
            <button data-voice="female"><i class="fas fa-female"></i> Female Voice</button>
        </div>
        <button id="favorite-btn"><i class="fas fa-star"></i> Favorite</button>
        <button id="export-btn"><i class="fas fa-file-export"></i> Export</button>
        <div class="export-options" id="export-options">
            <button data-export="pdf"><i class="fas fa-file-pdf"></i> PDF</button>
            <button data-export="word"><i class="fas fa-file-word"></i> Word</button>
            <button data-export="txt"><i class="fas fa-file-alt"></i> Text</button>
        </div>
        <button id="reply-btn"><i class="fas fa-reply"></i> Reply</button>
        <button id="edit-btn"><i class="fas fa-edit"></i> Edit</button>
        <div class="divider"></div>
        <button id="delete-btn" style="color: #ff6b6b;"><i class="fas fa-trash"></i> Delete</button>
    </div>

    <!-- Favorites View -->
    <div class="favorites-container" id="favorites-container">
        <div class="favorites-header">
            <h2 class="favorites-title">Your Favorites</h2>
            <button class="close-favorites" id="close-favorites">&times;</button>
        </div>
        <div class="favorites-list" id="favorites-list">
            <!-- Favorites will be populated here -->
        </div>
    </div>

    <!-- Enhanced Code Execution Modal -->
    <div class="code-modal" id="code-modal">
        <div class="code-modal-content">
            <div class="code-modal-header">
                <div class="code-modal-title">Code Execution Result</div>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            <div class="code-output-container">
                <div class="code-output" id="code-output"></div>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div class="image-modal" id="image-modal">
        <button class="close-image-modal" id="close-image-modal">&times;</button>
        <div class="image-modal-content">
            <img id="modal-image" src="" alt="Enlarged image">
        </div>
    </div>

    <!-- Clear Chat Button -->
    <button class="clear-btn" id="clear-btn" title="Clear conversation">
        <i class="fas fa-trash-alt"></i>
    </button>

    <!-- Favorites Button -->
    <button class="clear-btn" id="favorites-btn" title="View favorites" style="right: 80px;">
        <i class="fas fa-star"></i>
    </button>

    <script>
        const API_BASE_URL = 'https://zen-api.up.railway.app/api/llama-3.2-11b-vision-preview?query=';
        const IMAGE_API_URL = 'https://zen-api.up.railway.app/api/llama-3.2-11b-vision-preview?query=';
        
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const imageUploadButton = document.getElementById('image-upload-button');
        const imageUploadOptions = document.getElementById('image-upload-options');
        const uploadFromGallery = document.getElementById('upload-from-gallery');
        const capturePhoto = document.getElementById('capture-photo');
        const typingIndicator = document.getElementById('typing-indicator');
        const contextMenu = document.getElementById('context-menu');
        const voiceOptions = document.getElementById('voice-options');
        const loadingScreen = document.getElementById('loading-screen');
        const clearBtn = document.getElementById('clear-btn');
        const codeModal = document.getElementById('code-modal');
        const codeOutput = document.getElementById('code-output');
        const closeModal = document.getElementById('close-modal');
        const introScreen = document.getElementById('intro-screen');
        const getStartedBtn = document.getElementById('get-started-btn');
        const inputArea = document.getElementById('input-area');
        const imageModal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const closeImageModal = document.getElementById('close-image-modal');
        const favoritesBtn = document.getElementById('favorites-btn');
        const favoritesContainer = document.getElementById('favorites-container');
        const favoritesList = document.getElementById('favorites-list');
        const closeFavorites = document.getElementById('close-favorites');
        const exportOptions = document.getElementById('export-options');
        const header = document.getElementById('header');
        
        // State variables
        let longPressTimer;
        let selectedMessage = null;
        let selectedVoice = 'female'; // Default voice
        let currentImage = null;
        let replyingTo = null; // Track which message we're replying to
        const LONG_PRESS_DURATION = 600; // milliseconds
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Hide loading screen after short delay
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    // Show intro screen
                    introScreen.style.display = 'flex';
                    
                    // Check if user has seen intro before
                    const hasSeenIntro = localStorage.getItem('hasSeenIntro');
                    if (hasSeenIntro) {
                        startChat();
                    }
                }, 300);
            }, 800);
            
            // Get Started button click handler - FIXED VERSION
            getStartedBtn.addEventListener('click', () => {
                localStorage.setItem('hasSeenIntro', 'true');
                startChat();
            });
            
            // Load any saved messages
            loadMessages();
            
            // Close modal event
            closeModal.addEventListener('click', () => {
                codeModal.style.display = 'none';
            });
            
            // Close image modal event
            closeImageModal.addEventListener('click', () => {
                imageModal.style.display = 'none';
            });
            
            // Click outside modal to close
            codeModal.addEventListener('click', (e) => {
                if (e.target === codeModal) {
                    codeModal.style.display = 'none';
                }
            });
            
            // Click outside image modal to close
            imageModal.addEventListener('click', (e) => {
                if (e.target === imageModal) {
                    imageModal.style.display = 'none';
                }
            });
            
            // Favorites button click handler
            favoritesBtn.addEventListener('click', showFavorites);
            closeFavorites.addEventListener('click', () => {
                favoritesContainer.style.display = 'none';
            });
            
            // Initialize speech synthesis voices
            if ('speechSynthesis' in window) {
                // Some browsers need this to populate voices
                speechSynthesis.onvoiceschanged = function() {
                    console.log("Voices loaded:", speechSynthesis.getVoices());
                };
                
                // Try to get voices immediately
                const voices = speechSynthesis.getVoices();
                if (voices.length === 0) {
                    console.log("Waiting for voices to load...");
                }
            }

            // Image upload button click handler
            imageUploadButton.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleImageUploadOptions();
            });

            // Upload from gallery handler
            uploadFromGallery.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = handleImageSelection;
                input.click();
                imageUploadOptions.style.display = 'none';
            });

            // Capture photo handler
            capturePhoto.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.capture = 'environment'; // Prefer rear camera on mobile
                input.onchange = handleImageSelection;
                input.click();
                imageUploadOptions.style.display = 'none';
            });

            // Close image options when clicking elsewhere
            document.addEventListener('click', (e) => {
                if (!imageUploadButton.contains(e.target) && !imageUploadOptions.contains(e.target)) {
                    imageUploadOptions.style.display = 'none';
                }
            });
        });

        function toggleImageUploadOptions() {
            if (imageUploadOptions.style.display === 'flex') {
                imageUploadOptions.style.display = 'none';
            } else {
                // Position the options above the button
                const buttonRect = imageUploadButton.getBoundingClientRect();
                imageUploadOptions.style.left = `${buttonRect.left - 150}px`;
                imageUploadOptions.style.bottom = `${window.innerHeight - buttonRect.top + 10}px`;
                imageUploadOptions.style.display = 'flex';
            }
        }

        function handleImageSelection(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                alert('Please select an image file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImage = e.target.result;
                
                // Add the image to the chat
                addMessage('user', '', Date.now().toString(), currentImage);
                saveMessages();
                
                // Show typing indicator
                typingIndicator.style.display = 'flex';
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Simulate AI analyzing the image
                setTimeout(() => {
                    typingIndicator.style.display = 'none';
                    
                    // Generate a human-like response about the image
                    const responses = [
                        "Thanks for sharing this image! 😊 What would you like to know about it?",
                        "Interesting picture! I can help analyze it if you have any specific questions.",
                        "Nice image! I'd be happy to describe it or answer any questions you have about it.",
                        "I've received your image. What aspect would you like me to focus on?",
                        "Great visual! Let me know how I can assist you with this image.",
                        "I see what you've shared. What would you like me to tell you about this picture?"
                    ];
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    
                    addMessage('ai', randomResponse);
                    saveMessages();
                }, 2000);
            };
            reader.readAsDataURL(file);
        }

        function startChat() {
            // Hide intro screen with animation
            introScreen.classList.add('hidden');
            
            // Show chat interface after animation completes
            setTimeout(() => {
                introScreen.style.display = 'none';
                header.style.display = 'flex';
                chatContainer.style.display = 'flex';
                inputArea.style.display = 'flex';
                clearBtn.style.display = 'flex';
                favoritesBtn.style.display = 'flex';
                
                // Add welcome message if chat is empty
                if (chatContainer.children.length === 0) {
                    addMessage('ai', "Hi there! 👋 I'm Nexus AI. How can I help you today?");
                }
                
                // Focus the input field
                userInput.focus();
            }, 500);
        }

        // Clear chat function
        clearBtn.addEventListener('click', () => {
            chatContainer.innerHTML = '';
            localStorage.removeItem('nexus-ai-chat');
            addMessage('ai', "Hi there! 👋 I'm Nexus AI. How can I help you today?");
            userInput.focus();
        });
        
        function addMessage(role, content, id = Date.now().toString(), imageUrl = null, replyTo = null) {
            const container = document.createElement('div');
            container.className = `message-container ${role}-message-container`;
            container.dataset.messageId = id;
            
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Check if this message is favorited
            const favorites = JSON.parse(localStorage.getItem('nexus-ai-favorites')) || {};
            const isFavorited = favorites[id] ? true : false;
            
            let messageContent = '';
            if (imageUrl) {
                messageContent = `
                    <div class="message ${role}-message">
                        ${content ? `<div>${formatContent(content)}</div>` : ''}
                        <div class="image-preview-container">
                            <img src="${imageUrl}" class="image-message" alt="Uploaded image">
                        </div>
                        <div class="message-timestamp">${timestamp}</div>
                    </div>
                `;
            } else {
                // Add reply indicator if this is a reply
                let replyIndicator = '';
                if (replyTo) {
                    const repliedMessage = document.querySelector(`[data-message-id="${replyTo.id}"]`);
                    if (repliedMessage) {
                        const repliedContent = repliedMessage.querySelector('.message').textContent;
                        const repliedRole = repliedMessage.classList.contains('user-message-container') ? 'You' : 'Nexus AI';
                        replyIndicator = `
                            <div class="reply-indicator">
                                <span class="reply-username">Replying to ${repliedRole}</span>
                                <span class="reply-content">${repliedContent.length > 30 ? repliedContent.substring(0, 30) + '...' : repliedContent}</span>
                                <button class="cancel-reply-btn" title="Cancel reply"><i class="fas fa-times"></i></button>
                            </div>
                        `;
                    }
                }
                
                messageContent = `
                    <div class="message ${role}-message">
                        ${replyIndicator}
                        ${formatContent(content)}
                        <div class="message-timestamp">${timestamp}</div>
                        <div class="reaction-buttons">
                            <button class="reaction-btn like-btn ${isFavorited ? 'liked' : ''}" title="Like">
                                <i class="fas fa-thumbs-up"></i>
                            </button>
                            <button class="reaction-btn dislike-btn" title="Dislike">
                                <i class="fas fa-thumbs-down"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = `
                <img class="profile-pic" src="${role === 'user' ? 
                    'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'40\' r=\'20\' fill=\'%234a6bff\'/%3E%3Ccircle cx=\'50\' cy=\'100\' r=\'30\' fill=\'%234a6bff\'/%3E%3C/svg%3E' : 
                    'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Crect x=\'20\' y=\'20\' width=\'60\' height=\'60\' rx=\'10\' fill=\'%236c5ce7\'/%3E%3Ccircle cx=\'35\' cy=\'40\' r=\'5\' fill=\'white\'/%3E%3Ccircle cx=\'65\' cy=\'40\' r=\'5\' fill=\'white\'/%3E%3Cpath d=\'M35,65 Q50,75 65,65\' stroke=\'white\' stroke-width=\'4\' fill=\'none\'/%3E%3C/svg%3E'}" 
                    alt="${role}">
                <div class="message-content">
                    ${messageContent}
                    <textarea class="edit-message-input" style="display: none;">${content}</textarea>
                    <div class="edit-buttons" style="display: none;">
                        <button class="edit-btn save-edit-btn">Save</button>
                        <button class="edit-btn cancel-edit-btn">Cancel</button>
                    </div>
                </div>
            `;
            
            // Add event listeners for long press
            const messageElement = container.querySelector('.message');
            setupMessageInteractions(container, messageElement, role);
            
            // Add click event for image preview
            if (imageUrl) {
                const imgElement = container.querySelector('.image-message');
                imgElement.addEventListener('click', () => {
                    modalImage.src = imageUrl;
                    imageModal.style.display = 'flex';
                });
            }
            
            // Add event listener for cancel reply button
            const cancelReplyBtn = container.querySelector('.cancel-reply-btn');
            if (cancelReplyBtn) {
                cancelReplyBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    container.querySelector('.reply-indicator').remove();
                    saveMessages();
                });
            }
            
            // Add event listeners for reaction buttons
            const likeBtn = container.querySelector('.like-btn');
            const dislikeBtn = container.querySelector('.dislike-btn');
            
            if (likeBtn && dislikeBtn) {
                likeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleFavorite(container, id, content, role, timestamp);
                });
                
                dislikeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dislikeBtn.classList.toggle('disliked');
                    // You could add more dislike functionality here
                });
            }
            
            chatContainer.appendChild(container);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Setup code block buttons
            setupCodeBlockButtons();
            
            return container;
        }
        
        function toggleFavorite(container, id, content, role, timestamp) {
            const likeBtn = container.querySelector('.like-btn');
            likeBtn.classList.toggle('liked');
            
            const favorites = JSON.parse(localStorage.getItem('nexus-ai-favorites')) || {};
            
            if (likeBtn.classList.contains('liked')) {
                // Add to favorites
                favorites[id] = {
                    content,
                    role,
                    timestamp,
                    date: new Date().toISOString()
                };
            } else {
                // Remove from favorites
                delete favorites[id];
            }
            
            localStorage.setItem('nexus-ai-favorites', JSON.stringify(favorites));
        }
        
        function showFavorites() {
            favoritesList.innerHTML = '';
            const favorites = JSON.parse(localStorage.getItem('nexus-ai-favorites')) || {};
            
            if (Object.keys(favorites).length === 0) {
                favoritesList.innerHTML = '<p style="text-align: center; color: var(--timestamp-color);">No favorites yet</p>';
            } else {
                // Sort favorites by date (newest first)
                const sortedFavorites = Object.entries(favorites).sort((a, b) => {
                    return new Date(b[1].date) - new Date(a[1].date);
                });
                
                sortedFavorites.forEach(([id, fav]) => {
                    const favoriteItem = document.createElement('div');
                    favoriteItem.className = 'favorite-item';
                    favoriteItem.innerHTML = `
                        <div class="favorite-content">${formatContent(fav.content)}</div>
                        <div class="favorite-meta">
                            <span>${fav.role === 'user' ? 'You' : 'Nexus AI'}</span>
                            <span>${fav.timestamp}</span>
                        </div>
                        <button class="remove-favorite" data-id="${id}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    // Add remove button event
                    const removeBtn = favoriteItem.querySelector('.remove-favorite');
                    removeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeFavorite(id);
                        favoriteItem.remove();
                        
                        // Also update the like button in the chat if the message exists
                        const messageContainer = document.querySelector(`[data-message-id="${id}"]`);
                        if (messageContainer) {
                            const likeBtn = messageContainer.querySelector('.like-btn');
                            if (likeBtn) {
                                likeBtn.classList.remove('liked');
                            }
                        }
                    });
                    
                    favoritesList.appendChild(favoriteItem);
                });
            }
            
            favoritesContainer.style.display = 'flex';
        }
        
        function removeFavorite(id) {
            const favorites = JSON.parse(localStorage.getItem('nexus-ai-favorites')) || {};
            delete favorites[id];
            localStorage.setItem('nexus-ai-favorites', JSON.stringify(favorites));
        }
        
        function setupCodeBlockButtons() {
            // Setup copy buttons
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const codeBlock = this.closest('.code-block');
                    const code = codeBlock.querySelector('code').textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        const originalText = this.innerHTML;
                        this.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        setTimeout(() => {
                            this.innerHTML = originalText;
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                    });
                });
            });
            
            // Setup run buttons
            document.querySelectorAll('.run-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const codeBlock = this.closest('.code-block');
                    const code = codeBlock.querySelector('code').textContent;
                    const language = codeBlock.querySelector('.code-language').textContent.toLowerCase();
                    runCode(code, language);
                });
            });
        }
        
        function runCode(code, language) {
            // Clear previous output
            codeOutput.innerHTML = '';
            codeModal.style.display = 'flex';
            
            try {
                if (language === 'html') {
                    // Create iframe for HTML output
                    const iframe = document.createElement('iframe');
                    iframe.style.width = '100%';
                    iframe.style.height = '400px';
                    iframe.style.border = 'none';
                    iframe.style.background = 'white';
                    codeOutput.appendChild(iframe);
                    
                    // Write HTML to iframe
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    iframeDoc.open();
                    iframeDoc.write(code);
                    iframeDoc.close();
                    
                    // Add success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'execution-success';
                    successMsg.innerHTML = '<i class="fas fa-check-circle"></i> HTML rendered successfully';
                    codeOutput.insertBefore(successMsg, iframe);
                } 
                else if (language === 'javascript') {
                    // Execute JS code
                    const originalConsoleLog = console.log;
                    let output = '';
                    
                    // Override console.log to capture output
                    console.log = function() {
                        output += Array.from(arguments).join(' ') + '\n';
                        originalConsoleLog.apply(console, arguments);
                    };
                    
                    // Execute the code
                    try {
                        const result = new Function(code)();
                        if (result !== undefined) {
                            output += result.toString();
                        }
                        
                        // Add success message
                        const successMsg = document.createElement('div');
                        successMsg.className = 'execution-success';
                        successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Code executed successfully';
                        codeOutput.appendChild(successMsg);
                        
                        // Add output
                        const outputDiv = document.createElement('div');
                        outputDiv.className = 'code-output-content';
                        outputDiv.textContent = output || 'No output generated';
                        codeOutput.appendChild(outputDiv);
                    } catch (e) {
                        // Add error message
                        const errorMsg = document.createElement('div');
                        errorMsg.className = 'execution-error';
                        errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error executing code';
                        codeOutput.appendChild(errorMsg);
                        
                        // Add error details
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'code-output-content';
                        errorDiv.textContent = 'Error: ' + e.message;
                        codeOutput.appendChild(errorDiv);
                    }
                    
                    // Restore original console.log
                    console.log = originalConsoleLog;
                }
                else {
                    // Unsupported language
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'execution-error';
                    errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Unsupported language';
                    codeOutput.appendChild(errorMsg);
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'code-output-content';
                    errorDiv.textContent = `Code execution for ${language} is not supported in this view.`;
                    codeOutput.appendChild(errorDiv);
                }
            } catch (e) {
                // General error
                const errorMsg = document.createElement('div');
                errorMsg.className = 'execution-error';
                errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Execution failed';
                codeOutput.appendChild(errorMsg);
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'code-output-content';
                errorDiv.textContent = 'Error: ' + e.message;
                codeOutput.appendChild(errorDiv);
            }
        }
        
        function setupMessageInteractions(container, messageElement, role) {
            let isLongPress = false;
            let touchStartX = 0;
            let touchStartY = 0;
            
            // Touch events for mobile
            messageElement.addEventListener('touchstart', (e) => {
                isLongPress = false;
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                longPressTimer = setTimeout(() => {
                    isLongPress = true;
                    showContextMenu(container, messageElement, touchStartX, touchStartY);
                }, LONG_PRESS_DURATION);
            });
            
            messageElement.addEventListener('touchend', (e) => {
                clearTimeout(longPressTimer);
                if (!isLongPress && e.target.tagName !== 'A') {
                    // Handle normal tap if needed
                }
                e.preventDefault();
            });
            
            messageElement.addEventListener('touchmove', (e) => {
                // Only cancel if moved significantly
                if (Math.abs(e.touches[0].clientX - touchStartX) > 10 || 
                    Math.abs(e.touches[0].clientY - touchStartY) > 10) {
                    clearTimeout(longPressTimer);
                }
            });
            
            // Mouse events for desktop
            messageElement.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return; // Only left click
                isLongPress = false;
                longPressTimer = setTimeout(() => {
                    isLongPress = true;
                    showContextMenu(container, messageElement, e.clientX, e.clientY);
                }, LONG_PRESS_DURATION);
            });
            
            messageElement.addEventListener('mouseup', (e) => {
                clearTimeout(longPressTimer);
            });
            
            messageElement.addEventListener('mouseleave', () => {
                clearTimeout(longPressTimer);
            });
            
            // Allow text selection
            messageElement.addEventListener('selectstart', (e) => {
                if (isLongPress) {
                    e.preventDefault();
                }
            });
        }
        
        function showContextMenu(container, messageElement, x, y) {
            // Close any existing context menu
            contextMenu.style.display = 'none';
            voiceOptions.style.display = 'none';
            exportOptions.style.display = 'none';
            
            // Set the selected message
            selectedMessage = container;
            
            // Position the context menu at the touch point
            const menuWidth = 180;
            const menuHeight = 260;
            const adjustedX = Math.min(x, window.innerWidth - menuWidth - 10);
            const adjustedY = Math.min(y, window.innerHeight - menuHeight - 10);
            
            contextMenu.style.left = `${adjustedX}px`;
            contextMenu.style.top = `${adjustedY}px`;
            contextMenu.style.display = 'flex';
            
            // Check if this message is favorited
            const id = container.dataset.messageId;
            const favorites = JSON.parse(localStorage.getItem('nexus-ai-favorites')) || {};
            const isFavorited = favorites[id] ? true : false;
            
            // Update favorite button text
            const favoriteBtn = document.getElementById('favorite-btn');
            favoriteBtn.innerHTML = isFavorited ? 
                '<i class="fas fa-star"></i> Remove Favorite' : 
                '<i class="fas fa-star"></i> Favorite';
            
            // Set up menu items
            document.getElementById('copy-btn').onclick = () => {
                navigator.clipboard.writeText(messageElement.textContent).then(() => {
                    contextMenu.style.display = 'none';
                });
            };
            
            document.getElementById('select-text-btn').onclick = () => {
                const range = document.createRange();
                range.selectNodeContents(messageElement);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                contextMenu.style.display = 'none';
            };
            
            document.getElementById('speak-btn').onclick = () => {
                voiceOptions.style.display = voiceOptions.style.display === 'flex' ? 'none' : 'flex';
            };
            
            document.getElementById('favorite-btn').onclick = () => {
                const likeBtn = container.querySelector('.like-btn');
                if (likeBtn) {
                    likeBtn.click();
                }
                contextMenu.style.display = 'none';
            };
            
            document.getElementById('export-btn').onclick = () => {
                exportOptions.style.display = exportOptions.style.display === 'flex' ? 'none' : 'flex';
            };
            
            // Export options
            document.querySelectorAll('[data-export]').forEach(btn => {
                btn.onclick = (e) => {
                    const format = e.target.dataset.export;
                    exportMessage(container, format);
                    contextMenu.style.display = 'none';
                };
            });
            
            document.getElementById('reply-btn').onclick = () => {
                replyingTo = {
                    id: container.dataset.messageId,
                    content: messageElement.textContent,
                    role: container.classList.contains('user-message-container') ? 'user' : 'ai'
                };
                userInput.placeholder = `Replying to ${replyingTo.role === 'user' ? 'yourself' : 'Nexus AI'}...`;
                userInput.focus();
                contextMenu.style.display = 'none';
            };
            
            document.getElementById('edit-btn').onclick = () => editMessage(container);
            document.getElementById('delete-btn').onclick = () => deleteMessage(container);
            
            // Voice selection
            document.querySelectorAll('[data-voice]').forEach(btn => {
                btn.onclick = (e) => {
                    selectedVoice = e.target.dataset.voice;
                    speakMessage(messageElement.textContent);
                    contextMenu.style.display = 'none';
                };
            });
            
            // Close menu when clicking elsewhere
            const closeMenu = (e) => {
                if (!contextMenu.contains(e.target)) {
                    contextMenu.style.display = 'none';
                    voiceOptions.style.display = 'none';
                    exportOptions.style.display = 'none';
                    document.removeEventListener('click', closeMenu);
                    document.removeEventListener('touchstart', closeMenu);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', closeMenu);
                document.addEventListener('touchstart', closeMenu);
            }, 10);
        }
        
        function exportMessage(container, format) {
            const messageElement = container.querySelector('.message');
            const content = messageElement.textContent;
            const timestamp = container.querySelector('.message-timestamp').textContent;
            const role = container.classList.contains('user-message-container') ? 'You' : 'Nexus AI';
            
            switch (format) {
                case 'pdf':
                    exportToPDF(content, role, timestamp);
                    break;
                case 'word':
                    exportToWord(content, role, timestamp);
                    break;
                case 'txt':
                    exportToTXT(content, role, timestamp);
                    break;
            }
        }
        
        function exportToPDF(content, role, timestamp) {
            // Use jsPDF to create a PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont('helvetica');
            doc.setFontSize(12);
            
            // Add title
            doc.text(`Message from ${role} - ${timestamp}`, 10, 10);
            
            // Add content with word wrap
            const splitText = doc.splitTextToSize(content, 180);
            doc.text(splitText, 10, 20);
            
            // Save the PDF
            doc.save(`nexus-message-${timestamp}.pdf`);
        }
        
        function exportToWord(content, role, timestamp) {
            // Create a Blob with the content
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Message from ${role} - ${timestamp}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #4a00e0; font-size: 18px; }
                        p { white-space: pre-wrap; }
                    </style>
                </head>
                <body>
                    <h1>Message from ${role} - ${timestamp}</h1>
                    <p>${content}</p>
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            
            // Create a download link
            const a = document.createElement('a');
            a.href = url;
            a.download = `nexus-message-${timestamp}.doc`;
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        }
        
        function exportToTXT(content, role, timestamp) {
            // Create a Blob with the content
            const textContent = `Message from ${role} - ${timestamp}\n\n${content}`;
            const blob = new Blob([textContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            // Create a download link
            const a = document.createElement('a');
            a.href = url;
            a.download = `nexus-message-${timestamp}.txt`;
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        }
        
        function speakMessage(text) {
            if (!('speechSynthesis' in window)) {
                alert("Text-to-speech is not supported in your browser");
                return;
            }
            
            // Stop any currently speaking utterance
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            
            // Get available voices
            const voices = window.speechSynthesis.getVoices();
            
            // Try to find preferred voice
            let preferredVoice;
            if (selectedVoice === 'male') {
                preferredVoice = voices.find(v => v.name.includes('Male')) || 
                                voices.find(v => v.name.includes('Google UK English Male')) || 
                                voices.find(v => v.name.includes('Alex')) || 
                                voices[0];
            } else {
                preferredVoice = voices.find(v => v.name.includes('Female')) || 
                                 voices.find(v => v.name.includes('Google UK English Female')) || 
                                 voices.find(v => v.name.includes('Samantha')) || 
                                 voices[0];
            }
            
            if (preferredVoice) {
                utterance.voice = preferredVoice;
                utterance.rate = 0.9;
                utterance.pitch = selectedVoice === 'male' ? 0.9 : 1.1;
            }
            
            // Speak the message
            window.speechSynthesis.speak(utterance);
        }
        
        function editMessage(container) {
            const messageElement = container.querySelector('.message');
            const editInput = container.querySelector('.edit-message-input');
            const editButtons = container.querySelector('.edit-buttons');
            
            messageElement.style.display = 'none';
            editInput.style.display = 'block';
            editButtons.style.display = 'flex';
            editInput.focus();
            
            // Set cursor to end
            editInput.selectionStart = editInput.value.length;
            editInput.selectionEnd = editInput.value.length;
            
            // Save edit when clicking save button
            const saveBtn = container.querySelector('.save-edit-btn');
            saveBtn.addEventListener('click', () => {
                const newContent = editInput.value.trim();
                if (newContent) {
                    messageElement.innerHTML = formatContent(newContent) + 
                        `<div class="message-timestamp">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>`;
                }
                messageElement.style.display = 'block';
                editInput.style.display = 'none';
                editButtons.style.display = 'none';
                contextMenu.style.display = 'none';
                saveMessages();
            });
            
            // Cancel edit when clicking cancel button
            const cancelBtn = container.querySelector('.cancel-edit-btn');
            cancelBtn.addEventListener('click', () => {
                messageElement.style.display = 'block';
                editInput.style.display = 'none';
                editButtons.style.display = 'none';
                contextMenu.style.display = 'none';
            });
            
            // Also allow saving with Enter key
            editInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    saveBtn.click();
                }
            });
            
            // Close context menu
            contextMenu.style.display = 'none';
        }
        
        function deleteMessage(container) {
            const messageElement = container.querySelector('.message');
            
            // Apply vanishing effect to the text
            messageElement.style.animation = 'fadeOut 0.3s forwards';
            
            // Then remove the container
            setTimeout(() => {
                container.remove();
                saveMessages();
            }, 300);
            
            contextMenu.style.display = 'none';
        }
        
        function formatContent(content) {
            // Escape HTML tags first to prevent XSS
            content = content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            // Then handle code blocks
            if (content.includes('```')) {
                let formatted = '';
                const parts = content.split('```');
                
                parts.forEach((part, i) => {
                    if (i % 2 === 1) {
                        // This is a code block
                        const firstLineBreak = part.indexOf('\n');
                        let language = 'javascript';
                        let codeContent = part;
                        
                        if (firstLineBreak !== -1) {
                            const firstLine = part.substring(0, firstLineBreak).trim();
                            if (firstLine) {
                                language = firstLine.toLowerCase();
                                codeContent = part.substring(firstLineBreak + 1);
                            }
                        }
                        
                        formatted += `
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-language">${language}</span>
                                <div class="code-actions">
                                    <button class="code-btn copy-btn">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                    <button class="code-btn run-btn">
                                        <i class="fas fa-play"></i> Run
                                    </button>
                                </div>
                            </div>
                            <pre><code>${codeContent.trim()}</code></pre>
                        </div>`;
                    } else {
                        formatted += part;
                    }
                });
                
                return formatted;
            }
            
            // Format numbered lists with proper line breaks
            content = content.replace(/(\d+\.)\s/g, '<br><span class="step"><span class="step-number">$1</span> ');
            
            // Format bullet points
            content = content.replace(/(\*|-)\s/g, '<br>• ');
            
            // Highlight questions in AI responses
            if (content.includes('?')) {
                const sentences = content.split(/(?<=[?.!])\s+/);
                let formattedContent = '';
                
                for (let sentence of sentences) {
                    if (sentence.trim().endsWith('?')) {
                        formattedContent += `<span class="question-highlight">${sentence}</span> `;
                    } else {
                        formattedContent += sentence + ' ';
                    }
                }
                
                content = formattedContent.trim();
            }
            
            // Add line breaks for better readability
            content = content.replace(/\n/g, '<br>');
            
            return content;
        }
        
        async function sendMessage() {
            let message = userInput.value.trim();
            if (!message && !currentImage) return;
            
            // Add user message to chat
            if (currentImage) {
                addMessage('user', message, Date.now().toString(), currentImage, replyingTo);
            } else {
                addMessage('user', message, Date.now().toString(), null, replyingTo);
            }
            
            userInput.value = '';
            currentImage = null;
            replyingTo = null;
            userInput.placeholder = 'Message Nexus...';
            userInput.focus(); // Refocus input after sending
            
            // Show typing indicator
            typingIndicator.style.display = 'flex';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            try {
                // Check for specific questions
                const lowerMessage = message.toLowerCase();
                
                // Human-like responses for common questions
                if (lowerMessage.includes('who created you') || 
                    lowerMessage.includes('who is your creator') || 
                    lowerMessage.includes('who made you')) {
                    
                    // Hide typing indicator with delay to simulate thinking
                    setTimeout(() => {
                        typingIndicator.style.display = 'none';
                        addMessage('ai', "Oh, that's an interesting question! I was developed by CrisJhon P. Deguiñon, a really talented developer who built me to help people like you with all sorts of tasks. He put a lot of work into making me helpful and friendly!");
                        saveMessages();
                    }, 1500);
                    return;
                }
                
                // Check for greeting
                if (lowerMessage.includes('hello') || 
                    lowerMessage.includes('hi') || 
                    lowerMessage.includes('hey')) {
                    
                    // Hide typing indicator with delay
                    setTimeout(() => {
                        typingIndicator.style.display = 'none';
                        
                        // Randomize greeting responses
                        const greetings = [
                            "Hi there! 👋 How's your day going?",
                            "Hello! What can I do for you today?",
                            "Hey! 😊 Nice to see you. What's on your mind?",
                            "Hi! I'm here and ready to help. What do you need?"
                        ];
                        const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
                        addMessage('ai', randomGreeting);
                        saveMessages();
                    }, 1000);
                    return;
                }
                
                // Check for thanks
                if (lowerMessage.includes('thank') || lowerMessage.includes('thanks')) {
                    setTimeout(() => {
                        typingIndicator.style.display = 'none';
                        const thanksResponses = [
                            "You're very welcome! 😊 Happy to help.",
                            "No problem at all! Let me know if you need anything else.",
                            "Glad I could assist! Don't hesitate to ask if you have more questions.",
                            "Anytime! That's what I'm here for. 😊"
                        ];
                        const randomResponse = thanksResponses[Math.floor(Math.random() * thanksResponses.length)];
                        addMessage('ai', randomResponse);
                        saveMessages();
                    }, 800);
                    return;
                }
                
                // Default API call for other messages
                const response = await fetch(`${API_BASE_URL}${encodeURIComponent(message)}`);
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const data = await response.json();
                
                // Hide typing indicator with slight delay
                setTimeout(() => {
                    typingIndicator.style.display = 'none';
                    
                    // Process and clean the response
                    let aiResponse = data.response || "Hmm, I'm not sure how to respond to that. Could you try asking in a different way?";
                    
                    // Remove <think> tags if present
                    aiResponse = aiResponse.replace(/<think>.*?<\/think>/g, '');
                    
                    // Add some human-like imperfections
                    if (Math.random() > 0.7) {
                        // Occasionally add filler words
                        const fillers = ["Well, ", "You know, ", "So, ", "Actually, "];
                        aiResponse = fillers[Math.floor(Math.random() * fillers.length)] + aiResponse.toLowerCase();
                    }
                    
                    if (Math.random() > 0.8) {
                        // Occasionally add a follow-up question
                        const followUps = [
                            " Does that make sense?",
                            " What do you think about that?",
                            " Let me know if you need clarification.",
                            " Does that answer your question?"
                        ];
                        aiResponse += followUps[Math.floor(Math.random() * followUps.length)];
                    }
                    
                    // Add AI response to chat
                    addMessage('ai', aiResponse);
                    saveMessages();
                }, 1500);
            } catch (error) {
                console.error('Error:', error);
                setTimeout(() => {
                    typingIndicator.style.display = 'none';
                    addMessage('ai', "Oops! I ran into a little problem there. Could you try asking again? Sometimes that helps.");
                }, 1000);
            }
        }
        
        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Load and save messages to localStorage
        function saveMessages() {
            const messages = [];
            document.querySelectorAll('.message-container').forEach(container => {
                const role = container.classList.contains('user-message-container') ? 'user' : 'ai';
                const content = container.querySelector('.message').textContent;
                const imgElement = container.querySelector('.image-message');
                const imageUrl = imgElement ? imgElement.src : null;
                const replyIndicator = container.querySelector('.reply-indicator');
                const replyTo = replyIndicator ? {
                    id: container.dataset.messageId,
                    content: replyIndicator.querySelector('.reply-content').textContent,
                    role: replyIndicator.querySelector('.reply-username').textContent.includes('You') ? 'user' : 'ai'
                } : null;
                
                messages.push({ 
                    role, 
                    content,
                    imageUrl,
                    replyTo,
                    timestamp: container.querySelector('.message-timestamp').textContent
                });
            });
            localStorage.setItem('nexus-ai-chat', JSON.stringify(messages));
        }
        
        function loadMessages() {
            const savedMessages = localStorage.getItem('nexus-ai-chat');
            if (savedMessages) {
                try {
                    const messages = JSON.parse(savedMessages);
                    messages.forEach(msg => {
                        addMessage(msg.role, msg.content, Date.now().toString(), msg.imageUrl, msg.replyTo);
                    });
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                } catch (e) {
                    console.error('Failed to load messages:', e);
                }
            }
        }
    </script>
</body>
</html>